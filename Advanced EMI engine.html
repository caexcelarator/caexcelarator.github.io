<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced EMI Calculator - by CA Kedar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root { --primary:#1f3a5f; --secondary:#e9eef5; --accent:#2c7be5; --danger:#d63939; --text:#2e2e2e; --border:#d5dbe3; }
    *{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif}
    body{margin:0;background:#f4f6f9;color:var(--text)}
    h1,h2{margin:0 0 10px;color:var(--primary)}
    .container{max-width:1400px;margin:20px auto;padding:20px}
    .card{background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:20px;margin-bottom:20px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .field{display:flex;flex-direction:column}
    label{font-size:12px;font-weight:600;margin-bottom:4px}
    input,select{padding:8px 10px;border-radius:6px;border:1px solid var(--border);font-size:14px}
    input:disabled,select:disabled{background:#f1f3f6}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:15px}
    button{padding:10px 18px;border-radius:6px;border:none;cursor:pointer;font-weight:600;font-size:14px}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:var(--secondary)}
    .btn-danger{background:var(--danger);color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px;font-size:13px}
    th{background:#f0f3f8;text-align:center}
    td{text-align:right}
    td:first-child,th:first-child{text-align:center}
    td:nth-child(2){text-align:left}
    .error-cell{background:#ffe5e5;color:#a10000;font-weight:600}

@media print {
  button { display: none; }
  .card { box-shadow: none; }
  body { background: #fff; }
}



  </style>
</head>
<body>
<div class="container">
  <h1>Advanced EMI Calculator - (Multiple disbursements , Baloon Payments , Recurring Payments Enabled</h1>

  <!-- ================= LOAN DETAILS ================= -->
  <div class="card">
    <h2>Loan Details</h2>
    <div class="grid">
      <div class="field"><label>User Name</label><input id="userName"></div>
      <div class="field"><label>Bank Name</label><input id="bankName"></div>
      <div class="field"><label>Bank A/c Number</label><input id="bankAcc"></div>
      <div class="field"><label>Sanction Limit</label><input id="sanctionLimit" type="number"></div>
      <div class="field"><label>Sanction Date</label><input id="sanctionDate" type="date"></div>
      <div class="field"><label>EMI Start Date</label><input id="emiStartDate" type="date"></div>
      <div class="field"><label>Interest Rate (%)</label><input id="roi" type="number" step="0.01"></div>
      <div class="field"><label>Total Tenure (Months)</label><input id="tenure" type="number"></div>
      <div class="field"><label>Moratorium (Months)</label><input id="moratorium" type="number"></div>
      <div class="field"><label>Moratorium Interest Option</label>
        <select id="moroOption"><option value="">--Select--</option><option value="pay">Pay Interest Only</option><option value="add">Add Interest to Principal</option></select>
      </div>
      <div class="field"><label>Number Format</label>
        <select id="numFormat"><option value="none">None</option><option value="hundreds">Hundreds</option><option value="thousands">Thousands</option><option value="lakhs">Lakhs</option><option value="crores">Crores</option></select>
      </div>
    </div>
  </div>

  <!-- ================= DISBURSEMENTS ================= -->
  <div class="card">
    <h2>Disbursement Schedule</h2>
    <button class="btn-secondary" onclick="addRow('disbTable')">+ Add</button>
    <table id="disbTable"><thead><tr><th>Sr</th><th>Date</th><th>Amount</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- ================= PREPAYMENTS ================= -->
  <div class="card">
    <h2>Pre / Part Payments</h2>
    <button class="btn-secondary" onclick="addRow('prepTable')">+ Add</button>
    <table id="prepTable"><thead><tr><th>Sr</th><th>Date</th><th>Amount</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- ================= RECURRING ================= -->
  <div class="card">
    <h2>Recurring Extra Payments</h2>
    <button class="btn-secondary" onclick="addRow('recTable',true)">+ Add</button>
    <table id="recTable"><thead><tr><th>Sr</th><th>Start Date</th><th>End Date</th><th>Monthly Amount</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- ================= ACTIONS ================= -->
  <div class="card">
    <div class="actions">
      <button class="btn-primary" onclick="generateSchedule()">Generate Schedule</button>
      <button class="btn-danger" id="unlockBtn" onclick="unlockAll()" disabled>Unblock Edit</button>
<button class="btn-primary" onclick="exportExcel()">Export Excel</button>
<button class="btn-primary" onclick="exportPDF()">Export PDF</button>
    </div>
  </div>

  <!-- ================= MONTHLY ================= -->
  <div class="card">
    <h2>Monthly Repayment Schedule</h2>
    <table>
      <thead>
        <tr>
          <th>Sr</th><th>Month</th><th>Opening</th><th>Disbursement</th>
          <th>Pre / Part</th><th>Recurring</th><th>Interest Due</th>
          <th>Interest Paid</th><th>EMI Principal</th><th>Total EMI</th><th>Closing</th>
        </tr>
      </thead>
      <tbody id="repayBody"></tbody>
    </table>
  </div>

  <!-- ================= YEARLY ================= -->
  <div class="card">
    <h2>Year-wise Summary (FY)</h2>
    <table>
      <thead>
        <tr>
          <th>FY</th><th>Opening</th><th>Disbursement</th><th>Principal Repaid</th>
          <th>Interest Paid</th><th>Total EMI</th><th>Closing</th>
          <th>Short-term Due</th><th>Long-term Due</th>
        </tr>
      </thead>
      <tbody id="yearBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= STATE & UI ================= */
const state={locked:false};
function addRow(tableId,isRecurring=false){ if(state.locked) return; const tb=document.querySelector(`#${tableId} tbody`); const r=tb.insertRow(); r.innerHTML=isRecurring?`<td></td><td><input type=date></td><td><input type=date></td><td><input type=number></td><td><button onclick=delRow(this)>X</button></td>`:`<td></td><td><input type=date></td><td><input type=number></td><td><button onclick=delRow(this)>X</button></td>`; renumber(tb);} 
function delRow(b){if(state.locked)return;const tb=b.closest('tbody');b.closest('tr').remove();renumber(tb)}
function renumber(tb){[...tb.rows].forEach((r,i)=>r.cells[0].innerText=i+1)}
function lockInputs(){state.locked=true;document.querySelectorAll('input,select,button.btn-secondary').forEach(e=>e.disabled=true);unlockBtn.disabled=false}
function unlockAll(){state.locked=false;document.querySelectorAll('input,select,button').forEach(e=>e.disabled=false);repayBody.innerHTML='';yearBody.innerHTML='';}

/* ================= VALIDATIONS ================= */
function validateDatesAndLimits(){
  const s=new Date(sanctionDate.value);
  const e=new Date(emiStartDate.value);
  if(e<s){alert('EMI Start Date cannot be before Sanction Date');return false}

  const disbRows=[...disbTable.tBodies[0].rows];
  if(!disbRows.length){alert('At least one disbursement required');return false}

  let disbTotal=0;
  const disbs=disbRows.map(r=>{ const d=new Date(r.cells[1].querySelector('input').value); const a=+r.cells[2].querySelector('input').value||0; disbTotal+=a; return {d,a}; }).sort((a,b)=>a.d-b.d);

  for(const x of disbs){ if(x.d<s){alert('Disbursement date cannot be before Sanction Date');return false} }
  if(disbTotal>+sanctionLimit.value){alert('Total disbursement exceeds sanction limit');return false}
  if(e<disbs[0].d){alert('EMI Start Date cannot be before first disbursement');return false}

  const prepays=[...prepTable.tBodies[0].rows].map(r=>({ d:new Date(r.cells[1].querySelector('input').value), a:+r.cells[2].querySelector('input').value||0 })).sort((a,b)=>a.d-b.d);
  let running=0, di=0;
  prepays.forEach(p=>{ while(di<disbs.length && disbs[di].d<=p.d){ running+=disbs[di].a; di++; } if(p.a>running){ alert('Prepayment exceeds outstanding principal on '+p.d.toLocaleDateString()); throw new Error(); } running-=p.a; });

  const recurrings=[...recTable.tBodies[0].rows].map(r=>({ sd:new Date(r.cells[1].querySelector('input').value), ed:new Date(r.cells[2].querySelector('input').value), a:+r.cells[3].querySelector('input').value||0 }));
  recurrings.forEach(rec=>{ let rp=0, idx=0, dt=new Date(rec.sd); while(dt<=rec.ed){ while(idx<disbs.length && disbs[idx].d<=dt){ rp+=disbs[idx].a; idx++; } if(rec.a>rp){ alert('Recurring payment exceeds outstanding principal in '+dt.toLocaleDateString()); throw new Error(); } dt=addMonth(dt); } });

  return true;
}

/* ================= CORE ENGINE ================= */
let fyMap={};
function generateSchedule(){
  try{ if(!validateDatesAndLimits())return; }catch(e){return}
  lockInputs();

  fyMap={};
  repayBody.innerHTML='';

  const rate=(+roi.value||0)/1200;
  const totalTenure=+tenure.value||0;
  const moro=+moratorium.value||0;
  const emiMonths=totalTenure-moro;

  const disbs=[...disbTable.tBodies[0].rows].map(r=>({date:new Date(r.cells[1].querySelector('input').value),amt:+r.cells[2].querySelector('input').value||0,used:false})).sort((a,b)=>a.date-b.date);

  let principal=0;
  let d=new Date(Math.min(new Date(emiStartDate.value),disbs[0].date));

  function applyDisb(date){ let m=0; disbs.forEach(x=>{ if(!x.used && x.date<=date){ principal+=x.amt; m+=x.amt; x.used=true; } }); return m; }

  // MORATORIUM
  for(let m=1;m<=moro;m++){
    const disb=applyDisb(d);
    const opening=principal-disb;
    const prepay=getPrepayment(d);
    const recurring=getRecurring(d);
    principal=Math.max(0,principal-prepay-recurring);
    const interest=principal*rate;
    if(moroOption.value==='add') principal+=interest;
    addRowRepay(d,opening,disb,prepay,recurring,interest,moroOption.value==='pay'?interest:0,0,principal);
    d=addMonth(d);
  }

  // EMI PHASE
  for(let i=0;i<emiMonths;i++){
    const disb=applyDisb(d);
    const opening=principal-disb;
    const interest=principal*rate;
    const remaining=emiMonths-i;
    const emi=rate?principal*rate*Math.pow(1+rate,remaining)/(Math.pow(1+rate,remaining)-1):principal/remaining;
    const prepay=getPrepayment(d);
    const recurring=getRecurring(d);
    const emiPrin=Math.min(emi-interest,principal);
    principal=Math.max(0,principal-emiPrin-prepay-recurring);
    addRowRepay(d,opening,disb,prepay,recurring,interest,interest,emiPrin,principal);
    d=addMonth(d);
  }
}

/* ================= RENDERING ================= */
function addRowRepay(d,o,di,p,r,i,ip,ep,c){
  const tr=repayBody.insertRow();
  const totalEmi=ip+ep;
  const isError=(p+r+ep)>(o+di);
  tr.innerHTML=`<td>${repayBody.rows.length}</td><td>${d.toLocaleString('default',{month:'short',year:'numeric'})}</td>
    <td>${fmt(o)}</td><td>${fmt(di)}</td><td>${fmt(p)}</td><td>${fmt(r)}</td>
    <td>${fmt(i)}</td><td>${fmt(ip)}</td><td>${fmt(ep)}</td><td>${fmt(totalEmi)}</td>
    <td class="${isError?'error-cell':''}">${fmt(c)}</td>`;
  accumulateYear(d,o,di,ip,ep,p,r,c);
}

function fyKey(d){ return (d.getMonth()<3)?(d.getFullYear()-1)+'-'+d.getFullYear():d.getFullYear()+'-'+(d.getFullYear()+1); }
function accumulateYear(d,o,di,ip,ep,p,r,c){
  const fy=fyKey(d);
  if(!fyMap[fy]) fyMap[fy]={opening:o,disb:0,prin:0,intp:0,emi:0,closing:c};

  fyMap[fy].disb += di;

  // ✅ PRINCIPAL PAID = EMI Principal + Part Payment + Recurring
  fyMap[fy].prin += (ep + p + r);

  fyMap[fy].intp += ip;
  fyMap[fy].emi  += (ip + ep);
  fyMap[fy].closing = c;

  renderYear();
}
function renderYear(){
  yearBody.innerHTML='';
  Object.entries(fyMap).forEach(([fy,v])=>{
	const nextFYPrin = getNextFYPrincipal(fy);
    const st = Math.min(v.closing, nextFYPrin);
    const lt = Math.max(0, v.closing - st);
    const tr=yearBody.insertRow();
    tr.innerHTML=`<td>${fy}</td><td>${fmt(v.opening)}</td><td>${fmt(v.disb)}</td><td>${fmt(v.prin)}</td>
      <td>${fmt(v.intp)}</td><td>${fmt(v.emi)}</td><td>${fmt(v.closing)}</td><td>${fmt(st)}</td><td>${fmt(lt)}</td>`;
  });
}

/* ================= HELPERS ================= */
function getNextFYPrincipal(fy){
  const parts = fy.split('-').map(Number);   // e.g. "2024-2025"
  const nextFY = parts[1] + '-' + (parts[1] + 1);
  return fyMap[nextFY] ? fyMap[nextFY].prin : 0;
}
function getPrepayment(d){ let a=0; document.querySelectorAll('#prepTable tbody tr').forEach(r=>{ const dt=new Date(r.cells[1].querySelector('input').value); if(sameMonth(dt,d)) a+=+r.cells[2].querySelector('input').value||0; }); return a; }
function getRecurring(d){ let a=0; document.querySelectorAll('#recTable tbody tr').forEach(r=>{ const sd=new Date(r.cells[1].querySelector('input').value); const ed=new Date(r.cells[2].querySelector('input').value); if(d>=sd && d<=ed) a+=+r.cells[3].querySelector('input').value||0; }); return a; }
function sameMonth(a,b){ return a.getMonth()===b.getMonth() && a.getFullYear()===b.getFullYear(); }
function addMonth(d,n=1){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
function fmt(n){ let v=n; const f=numFormat.value; if(f==='hundreds')v/=100; if(f==='thousands')v/=1000; if(f==='lakhs')v/=100000; if(f==='crores')v/=10000000; return v.toFixed(2); }


function exportExcel(){

  if(!repayBody.rows.length){
    alert("Please generate schedule before exporting.");
    return;
  }

  const client = (userName.value || "Client").replace(/\s+/g,'_');
  const fyList = Object.keys(fyMap);
  const fyRange = fyList.length ? fyList[0] + "_to_" + fyList[fyList.length-1] : "FY";
  const fileName = `${client}_EMI_${fyRange}.xlsx`;

  const wb = XLSX.utils.book_new();

  /* ===== Sheet 1 : Loan Details ===== */
  const loanData = [
    ["User Name", userName.value],
    ["Bank Name", bankName.value],
    ["Bank A/c No", bankAcc.value],
    ["Sanction Limit", sanctionLimit.value],
    ["Sanction Date", sanctionDate.value],
    ["EMI Start Date", emiStartDate.value],
    ["Interest Rate (%)", roi.value],
    ["Tenure (Months)", tenure.value],
    ["Moratorium (Months)", moratorium.value],
    ["Moratorium Option", moroOption.value],
    ["Number Format", numFormat.value]
  ];
  const wsLoan = XLSX.utils.aoa_to_sheet(loanData);
  XLSX.utils.book_append_sheet(wb, wsLoan, "Loan Details");

  /* ===== Sheet 2 : Monthly Schedule ===== */
  const monthlyTable = document.getElementById("repayBody").parentElement;
  const wsMonthly = XLSX.utils.table_to_sheet(monthlyTable, { raw:false });
  XLSX.utils.book_append_sheet(wb, wsMonthly, "Monthly Schedule");

  /* ===== Sheet 3 : Yearly Summary ===== */
  const yearlyTable = document.getElementById("yearBody").parentElement;
  const wsYearly = XLSX.utils.table_to_sheet(yearlyTable, { raw:false });
  XLSX.utils.book_append_sheet(wb, wsYearly, "Yearly Summary");

  XLSX.writeFile(wb, fileName);
}


function exportPDF(){

  if(!repayBody.rows.length){
    alert("Please generate schedule first");
    return;
  }

  const client = (userName.value || "Client");
  const fyKeys = Object.keys(fyMap);
  const fyRange = fyKeys.length ? fyKeys[0] + " to " + fyKeys[fyKeys.length-1] : "";

  // ----- Build Loan Details HTML safely -----
  const loanDetailsHTML = `
    <table>
      <tr><th colspan="2">Loan Details</th></tr>
      <tr><td>User Name</td><td>${userName.value || ""}</td></tr>
      <tr><td>Bank Name</td><td>${bankName.value || ""}</td></tr>
      <tr><td>Bank A/c Number</td><td>${bankAcc.value || ""}</td></tr>
      <tr><td>Sanction Limit</td><td>${fmt(+sanctionLimit.value || 0)}</td></tr>
      <tr><td>Sanction Date</td><td>${sanctionDate.value || ""}</td></tr>
      <tr><td>EMI Start Date</td><td>${emiStartDate.value || ""}</td></tr>
      <tr><td>Interest Rate (%)</td><td>${roi.value || ""}</td></tr>
      <tr><td>Total Tenure (Months)</td><td>${tenure.value || ""}</td></tr>
      <tr><td>Moratorium (Months)</td><td>${moratorium.value || ""}</td></tr>
      <tr><td>Moratorium Option</td><td>${moroOption.value || ""}</td></tr>
      <tr><td>Number Format</td><td>${numFormat.value || ""}</td></tr>
    </table>
  `;

  const win = window.open('', '_blank');

  win.document.write(`
    <html>
    <head>
      <title>${client} – EMI Schedule (${fyRange})</title>
      <style>
        body { font-family: Arial; font-size: 12px; margin: 20px; }
        h2 { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 6px; font-size: 11px; }
        th { background: #f0f0f0; text-align: center; }
        td:first-child { width: 35%; font-weight: bold; }
        td { text-align: left; }
        .num { text-align: right; }
      </style>
    </head>
    <body>

      <h2>Loan & Facility Information</h2>
      ${loanDetailsHTML}

      <h2>Monthly Repayment Schedule</h2>
      ${repayBody.parentElement.outerHTML}

      <h2>Year-wise Summary</h2>
      ${yearBody.parentElement.outerHTML}

      <h2>Schedule 3 classification of Short Term and Long Term Dues Yearwise</h2>
      <p>
        Based on the loan records and repayment schedules examined, the outstanding
        loan balance has been classified into short-term and long-term borrowings
        in accordance with Schedule III of the Companies Act, 2013.
      </p>

    </body>
    </html>
  `);

  win.document.close();
  win.focus();
  win.print();
}




</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>
