<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Loan Moratorium Calculator</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
.container { background:#fff; padding:20px; border-radius:8px; max-width:1200px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.row { display:flex; gap:15px; margin-bottom:12px; }
.row label { flex:1; font-size:14px; }
.row input, .row select { width:100%; padding:6px; }
button { padding:10px 16px; background:#2b7cff; color:#fff; border:none; border-radius:6px; cursor:pointer; }
button.export { background:#28a745; margin-left:10px; }
button.tab { background:#6c757d; margin-right:5px; }
button.active { background:#2b7cff; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ccc; padding:6px; text-align:right; font-size:13px; }
th { background:#f0f0f0; text-align:center; }
.tabcontent { display:none; }

.kpis { display:flex; gap:15px; margin:15px 0; }
.kpi {
  flex:1;
  background:#f8f9fa;
  padding:14px;
  border-radius:8px;
  text-align:center;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}
.kpi span { font-size:12px; color:#555; }
.kpi b { font-size:18px; color:#2b7cff; display:block; margin-top:5px; }

.moratorium { background:#fff3cd; }
.emi { background:#eafaf1; }
.last { background:#e3f2fd; font-weight:bold; }
</style>
</head>

<body>
<div class="container">
<h2>Loan Moratorium Calculator</h2>

<!-- KPI YEAR SELECT -->
<div class="row">
  <label>View Summary For
    <select id="yearSelect" onchange="updateKPIs()">
      <option value="ALL">Overall (All Years)</option>
    </select>
  </label>
</div>

<!-- KPI CARDS -->
<div class="kpis">
  <div class="kpi"><span>Loan Amount</span><b id="kpiLoan">-</b></div>
  <div class="kpi"><span>Total Interest Paid</span><b id="kpiInterest">-</b></div>
  <div class="kpi"><span>Total EMI Paid</span><b id="kpiEMI">-</b></div>
</div>

<!-- INPUTS -->
<div class="row">
  <label>Client Name <input id="clientName"></label>
  <label>Bank Name <input id="bankName"></label>
  <label>Loan A/c No <input id="loanAcc"></label>
</div>

<div class="row">
  <label>Sanction Date <input type="date" id="sanctionDate"></label>
  <label>EMI Start Date <input type="date" id="emiStartDate"></label>
  <label>Loan Amount <input type="number" id="principal"></label>
</div>

<div class="row">
  <label>Rate (% p.a.) <input type="number" step="0.01" id="roi"></label>
  <label>Tenure (Months) <input type="number" id="tenureMonths"></label>
  <label>Moratorium (Months) <input type="number" id="moratorium"></label>
</div>

<div class="row">
  <label>Moratorium Type
    <select id="moratoriumType">
      <option value="pay">Pay Interest</option>
      <option value="add">Add to Principal</option>
    </select>
  </label>

  <label>Display Amounts In
    <select id="unitSelect" onchange="renderTables()">
      <option value="1">Actual</option>
      <option value="100">Hundreds</option>
      <option value="1000">Thousands</option>
      <option value="100000">Lakhs</option>
    </select>
  </label>
</div>

<button onclick="calculate()">Generate Schedule</button>
<button class="export" onclick="exportToExcel()">Export Monthly</button>

<hr>

<button class="tab active" onclick="openTab(event,'monthly')">Monthly</button>
<button class="tab" onclick="openTab(event,'fy')">FY Summary</button>

<!-- MONTHLY -->
<div id="monthly" class="tabcontent" style="display:block;">
<table id="resultTable">
<thead>
<tr>
<th>Month</th><th>Year</th><th>Opening</th><th>Interest</th>
<th>Interest Paid</th><th>Principal Paid</th><th>EMI Paid</th><th>Closing</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- FY -->
<div id="fy" class="tabcontent">
<table id="fyTable">
<thead>
<tr>
<th>FY</th><th>Opening</th><th>Interest Paid</th>
<th>Principal Paid</th><th>EMI Paid</th><th>Closing</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
let scheduleData = [];
let fyMapGlobal = {};

function openTab(e,t){
document.querySelectorAll('.tabcontent').forEach(x=>x.style.display='none');
document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
document.getElementById(t).style.display='block';
e.target.classList.add('active');
}

function format(v){
const u=+unitSelect.value||1;
return (v/u).toFixed(2);
}

function calculate(){
scheduleData=[]; fyMapGlobal={};
const P=+principal.value, r=+roi.value/1200, t=+tenureMonths.value, m=+moratorium.value||0;
let bal=P; let d=new Date(emiStartDate.value);

let temp=P;
if(moratoriumType.value==='add')for(let i=0;i<m;i++)temp+=temp*r;
const EMI=(temp*r*Math.pow(1+r,t-m))/(Math.pow(1+r,t-m)-1);

for(let i=0;i<t;i++){
let open=bal,intAcc=open*r,intPaid=0,prin=0;
if(i<m){ if(moratoriumType.value==='pay')intPaid=intAcc; else bal+=intAcc; }
else{ intPaid=intAcc; prin=EMI-intAcc; bal-=prin; }
scheduleData.push({date:new Date(d),open,intPaid,prin,emi:intPaid+prin,close:bal});
d.setMonth(d.getMonth()+1);
}
renderTables();
}

function renderTables(){
const tb=document.querySelector('#resultTable tbody');
tb.innerHTML='';
scheduleData.forEach((r,i)=>{
tb.innerHTML+=`<tr class="${r.prin==0?'moratorium':'emi'}">
<td>${r.date.toLocaleString('default',{month:'short'})}</td>
<td>${r.date.getFullYear()}</td>
<td>${format(r.open)}</td>
<td>${format(r.intPaid+r.prin)}</td>
<td>${format(r.intPaid)}</td>
<td>${format(r.prin)}</td>
<td>${format(r.emi)}</td>
<td>${format(r.close)}</td>
</tr>`;
});
buildFY();
updateKPIs();
}

function buildFY(){
fyMapGlobal={};
scheduleData.forEach((r,i)=>{
const y=r.date.getMonth()<3?r.date.getFullYear()-1:r.date.getFullYear();
const fy=y+'-'+(y+1);
if(!fyMapGlobal[fy])fyMapGlobal[fy]={open:r.open,int:0,emi:0,close:r.close};
fyMapGlobal[fy].int+=r.intPaid;
fyMapGlobal[fy].emi+=r.emi;
fyMapGlobal[fy].close=r.close;
});

yearSelect.innerHTML='<option value="ALL">Overall (All Years)</option>';
Object.keys(fyMapGlobal).forEach(fy=>{
yearSelect.innerHTML+=`<option value="${fy}">${fy}</option>`;
});

const tb=document.querySelector('#fyTable tbody');
tb.innerHTML='';
Object.entries(fyMapGlobal).forEach(([fy,r])=>{
tb.innerHTML+=`<tr>
<td>${fy}</td><td>${format(r.open)}</td>
<td>${format(r.int)}</td><td>${format(r.emi)}</td>
<td>${format(r.emi)}</td><td>${format(r.close)}</td>
</tr>`;
});
}

function updateKPIs(){
const fy=yearSelect.value,u=+unitSelect.value||1;
let open=0,int=0,emi=0;
if(fy==='ALL'){
open=scheduleData[0]?.open||0;
scheduleData.forEach(r=>{int+=r.intPaid; emi+=r.emi;});
}else{
const r=fyMapGlobal[fy]; if(!r)return;
open=r.open; int=r.int; emi=r.emi;
}
kpiLoan.innerText=(open/u).toFixed(2);
kpiInterest.innerText=(int/u).toFixed(2);
kpiEMI.innerText=(emi/u).toFixed(2);
}

function exportToExcel(){ alert('Export unchanged (visual only)'); }
</script>
</body>
</html>
